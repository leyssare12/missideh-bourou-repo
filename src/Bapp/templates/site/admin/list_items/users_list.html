{% extends 'site/admin/base_admin.html'%}
{% load static %}

    {% block title %}    <title>Manage Users</title>{% endblock %}
    {% block extra_css %}<link href="{% static 'css/admin/list_items/users_list.css'%}" rel="stylesheet" type="text/css">{% endblock %}
   {% block content %}
    <div class="user-management-container">
    <!-- Header avec statistiques -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    <div class="management-header">
        <h3>{{ page_title|default:"Gestion des membres " }}</h3>
        <div class="header-stats">
            <span class="stat-item">
                <i class="fas fa-users"></i>
                <strong>{{ total_users }}</strong> utilisateurs
            </span>
            {% if is_superuser %}
            <span class="stat-item">
                <i class="fas fa-crown"></i>
                Superadmin
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Barre d'actions -->
    <div class="action-bar">
        <div class="search-box">
            <input type="text" id="userSearch" placeholder="Rechercher par nom, email...">
            <i class="fas fa-search"></i>
        </div>
        <div class="action-buttons">
            <a href="{% url 'Bapp:list_users' %}" class="btn btn-refresh">
                <i class="fas fa-sync-alt"></i> Actualiser
            </a>
        </div>
    </div>

    <!-- Liste des utilisateurs -->
    <div class="user-list" id="userListContainer">
        {% for user in users_list %}
        <div class="user-card" data-user-id="{{ user.id }}" data-searchable="{{ user.prenoms|lower }} {{ user.name|lower }} {{ user.email|lower }} {{ user.telephone|lower }}">
            <div class="user-avatar">
                 {% if user.profile_picture%}
                    <img src="{{ MEDIA_URL }}{{ user.profile_picture.url }}" alt="Photo de profil" class="profile-pic">
                 {% else %}
                    <img src="{% static 'images/missidhe_bourou_img/cdd.jpeg' %}" alt="Profile" class="profile-pic">
                 {% endif %}
                {% if user.is_superuser %}
                <span class="badge-superuser" title="Superadmin">
                    <i class="fas fa-crown"></i>
                </span>
                {% endif %}
                {% if user.role == 'MODERATOR'%}
                    <span class="badge-superuser" title="Superadmin">
                        <i class="fas fa-user-shield"></i>
                    </span>
                {% endif %}
                {% if user.role == 'SECRETOR'%}
                    <span class="badge-superuser" title="Superadmin">
                        <i class="fas fa-user-tie"></i>
                    </span>
                {% endif %}
                {% if user.role == 'SECOND_SECRETOR'%}
                    <span class="badge-superuser" title="Superadmin">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </span>
                {% endif %}
                {% if user.role == 'EDITOR'%}
                    <span class="badge-superuser" title="Superadmin">
                        <i class="fas fa-user-edit"></i>
                    </span>
                {% endif %}
            </div>
            <div class="user-info">
                <h3>{{ user.get_full_name|default:user.prenoms }}</h3>
                <div class="user-meta">
                    <span class="meta-item">
                        <i class="fa-solid fa-user-nurse"></i>
                        {{ user.role}}
                    </span>
                    <span class="meta-item">
                        <i class="fa-solid fa-envelope"></i>
                        {{ user.email}}
                    </span>
                    <span class="meta-item">
                        <i class="fa-solid fa-id-card"></i>
                        {{ user.identifiant }}
                    </span>
                    <span class="meta-item">
                        <i class="far fa-calendar-alt"></i>
                        Inscrit le {{ user.date_joined|date:"d/m/Y" }}
                    </span>
                    {% if user.created_by %}
                    <span class="meta-item">
                        <i class="fas fa-user-edit"></i>
                        Créé par {{ user.created_by.prenoms }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div id="deleteUser" class="user-actions btn-delete">
                 {% if request.user.is_authenticated %}
                    <!--On modifie les données de l'utilisateur -->
                    <a href="{% url 'Bapp:edit_user' user.id %}" class="btn-action btn-edit" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </a>

                    <!--On confirme la suppression de l'utilisateur -->
                    <a href="{% url 'Bapp:delete_user' user.id %}" class="btn-action btn-delete" title="Supprimer">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="no-results">
            <i class="fas fa-user-slash fa-3x"></i>
            <h3>Aucun utilisateur trouvé</h3>
            <p>Essayez d'ajuster vos critères de recherche</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if users_list.paginator.num_pages > 1 %}
    <div class="custom-pagination">
        {% if users_list.has_previous %}
            <a href="?page=1" class="page-link first-page" title="Première page">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ users_list.previous_page_number }}" class="page-link" title="Page précédente">
                <i class="fas fa-angle-left"></i>
            </a>
        {% endif %}

        {% for num in users_list.paginator.page_range %}
            {% if users_list.number == num %}
                <span class="current-page">{{ num }}</span>
            {% elif num > users_list.number|add:'-3' and num < users_list.number|add:'3' %}
                <a href="?page={{ num }}" class="page-link">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if users_list.has_next %}
            <a href="?page={{ users_list.next_page_number }}" class="page-link" title="Page suivante">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ users_list.paginator.num_pages }}" class="page-link last-page" title="Dernière page">
                <i class="fas fa-angle-double-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}


{% block extra_js %}<script src="{% static 'js/admin/list_items/users_list.js' %}"></script>{% endblock %}
