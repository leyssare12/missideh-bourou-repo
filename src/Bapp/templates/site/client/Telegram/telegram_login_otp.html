<!-- templates/site/client/Telegram/telegram_login_otp.html -->
{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Connexion 2FA Telegram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .tg-container { max-width: 680px; margin: 2rem auto; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.25rem; }
    .btn { display: inline-block; padding: 0.75rem 1.1rem; border-radius: 8px; background: #2ea6ff; color: #fff; text-decoration: none; font-weight: 600; }
    .btn:hover { background: #1d8fe6; }
    .muted { color: #6b7280; font-size: 0.95rem; }
    .link { word-break: break-all; }
    .actions { margin-top: 1rem; display: flex; gap: .75rem; }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { background: #565c67; }
    .messages { margin: 1rem 0; }
    .msg { padding: .75rem 1rem; border-radius: 8px; margin-bottom: .5rem; }
    .msg.error { background: #fee2e2; color: #991b1b; }
    .msg.success { background: #dcfce7; color: #14532d; }
    .msg.warning { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>
  <div class="tg-container">
    <h1>Connexion 2FA via Telegram</h1>

    <div class="messages">
      {% for message in messages %}
        <div class="msg {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>

    {% if not user_exist %}
      <div class="card">
        <p class="muted">Entrez votre identifiant pour démarrer la liaison avec Telegram.</p>
        <form method="post">
          {% csrf_token %}
          <input type="text" name="identifiant" placeholder="Identifiant" required>
          <button type="submit" class="btn">Continuer</button>
        </form>
      </div>
    {% else %}
      <div class="card">
        <h2>Lier votre compte Telegram</h2>
        <p class="muted">
          Cliquez sur le bouton ci-dessous pour ouvrir Telegram, démarrer le bot et lier votre compte.
        </p>

        {% if bot_username and start_token %}
          <p>
            <a class="btn"
               href="https://t.me/{{ bot_username }}?start={{ start_token }}"
               rel="noopener noreferrer">
              Ouvrir Telegram et démarrer le bot
            </a>
          </p>

          <p class="muted">
            Si l’application Telegram est installée et que le lien ci-dessus n’ouvre pas l’app, essayez ce lien natif:
          </p>
          <p class="link">
            <a href="tg://resolve?domain={{ bot_username }}&start={{ start_token }}">
              tg://resolve?domain={{ bot_username }}&start={{ start_token }}
            </a>
          </p>
        {% else %}
          <p class="muted">Le lien n’est pas disponible pour le moment. Réessayez plus tard.</p>
        {% endif %}

        <div class="actions">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="check">
            <button type="submit" class="btn btn-secondary">J’ai démarré le bot, continuer</button>
          </form>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="identifiant" value="">
            <button type="submit" class="btn btn-secondary">Changer d’identifiant</button>
          </form>
        </div>

        <hr>
        <p class="muted">
          Astuce: assurez-vous de ne pas bloquer le bot dans Telegram. Une fois lié, nous pourrons finaliser la 2FA.
        </p>
      </div>
    {% endif %}
  </div>
</body>
</html>
