{% extends "site/client/base_client.html" %}
{% load static %}

{% block title %}<title>Dons</title>{% endblock %}
{% block extra_css %}<link href="{% static 'css/client/caisse/dons_view.css'%}" rel="stylesheet" type="text/css">{% endblock %}


{% block content %}
<section class="coti-container" aria-labelledby="dons-title">
  <div class="coti-header">
    <h1 id="dons-title" class="coti-title">
      <i class="fa-solid fa-hand-holding-heart" aria-hidden="true"></i>
      Dons
    </h1>
    <div class="coti-tools">
      <div class="coti-search">
        <input type="search" id="cotiFilter" placeholder="Rechercher par nom, prénom ou motif…"
               aria-label="Filtrer les dons">
        <i class="fa-solid fa-search" aria-hidden="true"></i>
      </div>
    </div>
  </div>

  {% if page_obj and page_obj.object_list %}
    <!-- Cartes (mobiles / petits écrans) -->
    <div class="coti-grid" id="cotiGrid">
      {% for item in page_obj %}
        <article class="coti-card"
                 data-nom="{{ item.nom|default_if_none:''|lower }}"
                 data-prenom="{{ item.prenom|lower }}"
                 data-motif="{{ item.motif_don|lower }}">
          <div class="coti-row">
            <span class="label"><i class="fa-solid fa-user" aria-hidden="true"></i> Donateur</span>
            <strong>{{ item.prenom }}{% if item.nom %} {{ item.nom }}{% endif %}</strong>
          </div>
          <div class="coti-row">
            <span class="label"><i class="fa-solid fa-coins" aria-hidden="true"></i> Montant</span>
            <span class="coti-amount"><i class="fa-solid fa-sack-dollar" aria-hidden="true"></i> {{ item.montant_don }}</span>
          </div>
          <div class="coti-row">
            <span class="label"><i class="fa-solid fa-file-lines" aria-hidden="true"></i> Motif</span>
            <span>{{ item.motif_don }}</span>
          </div>
          <div class="coti-row">
            <span class="label"><i class="fa-solid fa-calendar-day" aria-hidden="true"></i> Date</span>
            <time class="coti-date">{{ item.date_don }}</time>
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- Tableau (desktop + tablette paysage) -->
    <div class="coti-table-wrapper" id="cotiTableWrapper" aria-hidden="true">
      <table class="coti-table" id="cotiTable">
        <thead>
          <tr>
            <th>Prénom</th>
            <th>Nom</th>
            <th>Montant</th>
            <th>Motif</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for item in page_obj %}
          <tr data-nom="{{ item.nom|default_if_none:''|lower }}"
              data-prenom="{{ item.prenom|lower }}"
              data-motif="{{ item.motif_don|lower }}">
            <td>{{ item.prenom }}</td>
            <td>{{ item.nom }}</td>
            <td class="tbl-amount">{{ item.montant_don }}</td>
            <td>{{ item.motif_don }}</td>
            <td class="tbl-date">{{ item.date_don }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <nav class="coti-pagination" role="navigation" aria-label="Pagination">
        {% if page_obj.has_previous %}
          <a class="coti-page-btn" href="?page=1" aria-label="Première page">
            <i class="fa-solid fa-angles-left" aria-hidden="true"></i>
          </a>
          <a class="coti-page-btn" href="?page={{ page_obj.previous_page_number }}" aria-label="Page précédente">
            <i class="fa-solid fa-angle-left" aria-hidden="true"></i> Précédent
          </a>
        {% endif %}

        <span class="coti-page-info" aria-live="polite">
          Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a class="coti-page-btn" href="?page={{ page_obj.next_page_number }}" aria-label="Page suivante">
            Suivant <i class="fa-solid fa-angle-right" aria-hidden="true"></i>
          </a>
          <a class="coti-page-btn" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Dernière page">
            <i class="fa-solid fa-angles-right" aria-hidden="true"></i>
          </a>
        {% endif %}
      </nav>
    {% endif %}
  {% else %}
    <div class="coti-empty" role="status">
      <p><i class="fa-regular fa-folder-open" aria-hidden="true"></i></p>
      <p>Aucun don trouvé.</p>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const input = document.getElementById('cotiFilter');
    const grid = document.getElementById('cotiGrid');
    const table = document.getElementById('cotiTable');

    if (!input) return;

    const filterFn = (q) => {
      const query = q.trim().toLowerCase();

      // Filtre cartes
      if (grid) {
        grid.querySelectorAll('.coti-card').forEach(card => {
          const nom = (card.getAttribute('data-nom') || '');
          const prenom = (card.getAttribute('data-prenom') || '');
          const motif = (card.getAttribute('data-motif') || '');
          const visible = !query || nom.includes(query) || prenom.includes(query) || motif.includes(query);
          card.style.display = visible ? '' : 'none';
        });
      }

      // Filtre tableau
      if (table) {
        table.querySelectorAll('tbody tr').forEach(row => {
          const nom = (row.getAttribute('data-nom') || '');
          const prenom = (row.getAttribute('data-prenom') || '');
          const motif = (row.getAttribute('data-motif') || '');
          const visible = !query || nom.includes(query) || prenom.includes(query) || motif.includes(query);
          row.style.display = visible ? '' : 'none';
        });
      }
    };

    input.addEventListener('input', function () {
      filterFn(this.value);
    });
  })();
</script>
{% endblock %}